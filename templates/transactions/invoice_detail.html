{% extends 'base.html' %}

{% block content %}
<style>
    @media print {
        body * {
            visibility: hidden;
        }

        #invoice-area,
        #invoice-area * {
            visibility: visible;
        }

        #invoice-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }

        .no-print {
            display: none;
        }
    }
</style>

<div class="max-w-4xl mx-auto bg-white p-8 rounded shadow-lg" id="invoice-area">

    <!-- Header -->
    <div class="border-b pb-6 mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-4xl font-bold text-slate-800">AgriRetail Shop</h1>
                <p class="text-gray-600">123 Farm Road, Green Valley</p>
                <p class="text-gray-600">Phone: +91 98765 43210</p>
                <p class="text-gray-600">GSTIN: 22AAAAA0000A1Z5</p>
            </div>
            <div class="text-right">
                <h2 class="text-2xl font-bold text-gray-700">INVOICE</h2>
                <p class="text-lg font-mono text-gray-900 mt-2">{{ invoice.invoice_number }}</p>
                <p class="text-gray-600">Date: {{ invoice.date }}</p>
            </div>
        </div>
    </div>

    <!-- Bill To -->
    <div class="mb-8">
        <h3 class="text-gray-600 uppercase tracking-wider text-sm font-bold mb-2">Bill To:</h3>
        {% if invoice.customer %}
        <p class="font-bold text-lg">{{ invoice.customer.name }} - {{ invoice.customer.city|default:"" }}</p>
        <p>{{ invoice.customer.address }}</p>
        <p>Phone: {{ invoice.customer.mobile_no }}</p>
        {% if invoice.customer.gstin %}<p>GSTIN: {{ invoice.customer.gstin }}</p>{% endif %}
        {% else %}
        <p class="italic text-gray-500">Walking Customer</p>
        {% endif %}
    </div>

    <!-- Items -->
    <table class="min-w-full mb-8">
        <thead>
            <tr class="border-b-2 border-slate-800">
                <th class="text-left py-2">Item Description</th>
                <th class="text-right py-2">Batch</th>
                <th class="text-right py-2">Qty</th>
                <th class="text-right py-2">Rate</th>
                <th class="text-right py-2">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in invoice.items.all %}
            <tr class="border-b border-gray-200">
                <td class="py-2">{{ item.batch.product.name }}</td>
                <td class="text-right py-2">{{ item.batch.batch_number }}</td>
                <td class="text-right py-2">{{ item.quantity }}</td>
                <td class="text-right py-2">{{ item.unit_price }}</td>
                <td class="text-right py-2 font-medium">{{ item.total_amount }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Sprint 40: Receipt History -->
    <div class="bg-gray-50/50 rounded-[2.5rem] p-8 mb-8 no-print">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">Receipt History</h3>
            <button onclick="document.getElementById('receiptModal').classList.remove('hidden')"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-xl shadow-lg shadow-green-600/20 transition-all flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Record Receipt
            </button>
        </div>

        {% if invoice.payments.exists %}
        <div class="space-y-3">
            {% for payment in invoice.payments.all %}
            <div
                class="bg-white rounded-2xl p-5 shadow-sm border border-green-100 flex justify-between items-center group">
                <div class="flex items-center gap-4">
                    <div
                        class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-600 font-bold text-xs">
                        {{ payment.payment_mode|slice:":1" }}
                    </div>
                    <div>
                        <p class="font-bold text-gray-900">₹{{ payment.amount }}</p>
                        <p class="text-xs text-gray-500">{{ payment.payment_date }} • {{ payment.payment_mode }}</p>
                        {% if payment.notes %}<p class="text-xs text-gray-400 mt-1">"{{ payment.notes }}"</p>{% endif %}
                    </div>
                </div>

                <form action="{% url 'delete_customer_payment' payment.pk %}" method="post"
                    onsubmit="return confirm('Delete this receipt?');">
                    {% csrf_token %}
                    <button type="submit"
                        class="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors opacity-0 group-hover:opacity-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>

        <!-- Summary Footer -->
        <div class="mt-6 flex justify-between items-center text-sm font-bold text-gray-600 px-2">
            <span>Total Received</span>
            <span class="text-green-600">₹{{ invoice.amount_received }}</span>
        </div>
        <div class="flex justify-between items-center text-sm font-bold text-gray-600 px-2 mt-2">
            <span>Balance Due</span>
            <span class="text-red-500">₹{{ invoice.balance_due }}</span>
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-400">
            <p>No payments recorded yet.</p>
        </div>
        {% endif %}
    </div>

    <!-- Record Receipt Modal -->
    <div id="receiptModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                onclick="document.getElementById('receiptModal').classList.add('hidden')"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form action="{% url 'record_receipt' invoice.pk %}" method="post" class="p-8">
                    {% csrf_token %}
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">Record Receipt</h3>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Amount Received</label>
                            <input type="number" step="0.01" name="amount" required max="{{ invoice.balance_due }}"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-bold text-gray-900 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none"
                                placeholder="0.00" value="{{ invoice.balance_due }}">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Payment Mode</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="cursor-pointer">
                                    <input type="radio" name="payment_mode" value="CASH" class="peer sr-only" checked>
                                    <div
                                        class="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-center font-bold text-gray-500 peer-checked:bg-green-50 peer-checked:text-green-600 peer-checked:border-green-200 transition-all">
                                        Cash</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="payment_mode" value="UPI" class="peer sr-only">
                                    <div
                                        class="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-center font-bold text-gray-500 peer-checked:bg-green-50 peer-checked:text-green-600 peer-checked:border-green-200 transition-all">
                                        UPI</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="payment_mode" value="CHEQUE" class="peer sr-only">
                                    <div
                                        class="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-center font-bold text-gray-500 peer-checked:bg-green-50 peer-checked:text-green-600 peer-checked:border-green-200 transition-all">
                                        Cheque</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="payment_mode" value="BANK" class="peer sr-only">
                                    <div
                                        class="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-center font-bold text-gray-500 peer-checked:bg-green-50 peer-checked:text-green-600 peer-checked:border-green-200 transition-all">
                                        Bank</div>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Date</label>
                            <input type="date" name="payment_date" required value="{% now 'Y-m-d' %}"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-medium text-gray-900 outline-none">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Notes</label>
                            <textarea name="notes" rows="2"
                                class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-medium text-gray-900 outline-none resize-none"
                                placeholder="Ref ID, Transaction # etc..."></textarea>
                        </div>
                    </div>

                    <div class="mt-8 flex gap-3">
                        <button type="button" onclick="document.getElementById('receiptModal').classList.add('hidden')"
                            class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-xl transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-green-600/30 transition-all">
                            Save Receipt
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Totals -->
    <div class="flex justify-end mb-8">
        <div class="w-1/2">
            <div class="flex justify-between py-2 border-b">
                <span>Taxable Amount</span>
                <span class="font-medium">{{ invoice.total_taxable }}</span>
            </div>
            <div class="flex justify-between py-2 border-b">
                <span>CGST</span>
                <span class="font-medium">{{ invoice.total_cgst }}</span>
            </div>
            <div class="flex justify-between py-2 border-b">
                <span>SGST</span>
                <span class="font-medium">{{ invoice.total_sgst }}</span>
            </div>
            <div class="flex justify-between py-2 text-xl font-bold mt-2">
                <span>Grand Total</span>
                <span>₹{{ invoice.grand_total }}</span>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-gray-500 text-sm border-t pt-4">
        <p>Thank you for your business!</p>
        <p>Terms & Conditions Apply.</p>
    </div>

    <!-- Print Button (Hidden in Print) -->
    <div class="mt-8 text-center no-print">
        <button onclick="window.print()" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-6 rounded">
            Print Invoice
        </button>
        <a href="{% url 'sales_list' %}" class="ml-4 text-blue-600 hover:underline">Back to Sales</a>
    </div>

</div>
{% endblock %}